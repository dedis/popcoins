"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Dialog = require("tns-core-modules/ui/dialogs");
const Badge = require("~/lib/pop/Badge");
const Log_1 = require("~/lib/Log");
const Scan = require("../../lib/Scan");
const Convert = require("~/lib/Convert");
const RequestPath = require("~/lib/network/RequestPath");
const observable_1 = require("tns-core-modules/data/observable");
let view = undefined;
function onNavigatingTo(args) {
    Log_1.default.print("navigating to: parties-page");
    view = args.object;
    view.bindingContext = observable_1.fromObject({
        party: undefined,
        config: {},
        qrcode: undefined
    });
    return loadParties();
}
exports.onNavigatingTo = onNavigatingTo;
function updateView(party) {
    if (party) {
        view.bindingContext.config = party.config;
        view.bindingContext.qrcode = party.qrcodePublic();
        view.bindingContext.party = party;
    }
    else {
        view.bindingContext.party = undefined;
        view.bindingContext.config = {};
    }
}
function loadParties() {
    return Badge.Badge.loadAll()
        .then(upcoming => {
        Object.values(upcoming).forEach(party => {
            if (party.state() == Badge.STATE_PUBLISH) {
                updateView(party);
            }
        });
    })
        .catch(err => {
        Log_1.default.catch(err);
    });
}
function addParty() {
    return Scan.scan()
        .then(string => {
        const infos = Convert.jsonToObject(string);
        return Badge.MigrateFrom.conodeGetWallet(infos.address, infos.omniledgerId, infos.id);
    })
        .catch(error => {
        return Dialog.prompt({
            // This is for the iOS simulator that doesn't have a
            // camera - in the simulator it's easy to copy/paste the
            // party-id, whereas on a real phone you wouldn't want
            // to do that.
            title: "Party-ID",
            message: "Couldn't scan party-id. Please enter party-id manually.",
            okButtonText: "Join Party",
            cancelButtonText: "Quit",
            defaultText: "",
            inputType: Dialog.inputType.text
        }).then(r => {
            if (r) {
                return Badge.MigrateFrom.conodeGetWallet("tls://gasser.blue:7002", RequestPath.OMNILEDGER_INSTANCE_ID, r.text);
            }
            else {
                throw new Error("Aborted party-id");
            }
        });
    })
        .then(newParty => {
        newParty.attendeesAdd([newParty.keypair.public]);
        return newParty.save()
            .then(() => {
            updateView(newParty);
        })
            .catch(error => {
            Dialog.alert({
                title: "Saving error",
                message: "Couldn't save the party: " + error,
                okButtonText: "OK"
            });
        });
    })
        .catch(err => {
        Log_1.default.catch(err, "error:");
        return Dialog.alert({
            title: "Remote parties error",
            message: err,
            okButtonText: "Continue"
        }).then(() => {
            throw new Error(err);
        });
    });
}
exports.addParty = addParty;
function partyTap(args) {
    if (!view.bindingContext.party) {
        return;
    }
    const actionShare = "Share party-definition";
    const actionDelete = "Delete party";
    return Dialog.action({
        message: "What do you want to do?",
        cancelButtonText: "Cancel",
        actions: [actionShare, actionDelete]
    }).then(result => {
        switch (result) {
            case actionShare:
                view.showModal("pages/common/qr-code/qr-code-page", {
                    textToShow: Convert.objectToJson({
                        id: view.bindingContext.party.config.hashStr(),
                        omniledgerId: RequestPath.OMNILEDGER_INSTANCE_ID,
                        address: view.bindingContext.party.linkedConode.tcpAddr
                    }),
                    title: "Party information",
                }, () => {
                }, true);
                break;
            case actionDelete:
                return Dialog.confirm("Do you really want to delete that party?")
                    .then(del => {
                    if (del) {
                        view.bindingContext.party.remove();
                    }
                    updateView(undefined);
                })
                    .catch(err => {
                    Log_1.default.rcatch(err);
                });
        }
    });
}
exports.partyTap = partyTap;
function onReload() {
}
exports.onReload = onReload;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGllcy1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGFydGllcy1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esc0RBQXNEO0FBRXRELHlDQUF5QztBQUN6QyxtQ0FBNEI7QUFDNUIsdUNBQXVDO0FBQ3ZDLHlDQUF5QztBQUN6Qyx5REFBeUQ7QUFDekQsaUVBQTREO0FBRzVELElBQUksSUFBSSxHQUFTLFNBQVMsQ0FBQztBQUUzQix3QkFBK0IsSUFBbUI7SUFDOUMsYUFBRyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQ3pDLElBQUksR0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsdUJBQVUsQ0FBQztRQUM3QixLQUFLLEVBQUUsU0FBUztRQUNoQixNQUFNLEVBQUUsRUFBRTtRQUNWLE1BQU0sRUFBRSxTQUFTO0tBQ3BCLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUN6QixDQUFDO0FBVEQsd0NBU0M7QUFFRCxvQkFBb0IsS0FBa0I7SUFDbEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNSLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDMUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2xELElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN0QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFDdEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ3BDLENBQUM7QUFDTCxDQUFDO0FBRUQ7SUFDSSxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxP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LENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ1IsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzt3QkFDTixJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDdkMsQ0FBQztvQkFDRCxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzFCLENBQUMsQ0FBQztxQkFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ1QsYUFBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLENBQUM7UUFDZixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDO0FBdENELDRCQXNDQztBQUVEO0FBQ0EsQ0FBQztBQURELDRCQUNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFdmVudERhdGEsIE5hdmlnYXRlZERhdGEsIFBhZ2UsIFZpZXd9IGZyb20gXCJ1aS9wYWdlXCI7XG5pbXBvcnQgKiBhcyBEaWFsb2cgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvZGlhbG9nc1wiO1xuXG5pbXBvcnQgKiBhcyBCYWRnZSBmcm9tIFwifi9saWIvcG9wL0JhZGdlXCI7XG5pbXBvcnQgTG9nIGZyb20gXCJ+L2xpYi9Mb2dcIjtcbmltcG9ydCAqIGFzIFNjYW4gZnJvbSBcIi4uLy4uL2xpYi9TY2FuXCI7XG5pbXBvcnQgKiBhcyBDb252ZXJ0IGZyb20gXCJ+L2xpYi9Db252ZXJ0XCI7XG5pbXBvcnQgKiBhcyBSZXF1ZXN0UGF0aCBmcm9tIFwifi9saWIvbmV0d29yay9SZXF1ZXN0UGF0aFwiO1xuaW1wb3J0IHtmcm9tT2JqZWN0fSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9kYXRhL29ic2VydmFibGVcIjtcbmltcG9ydCB7SXRlbUV2ZW50RGF0YX0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvbGlzdC12aWV3XCI7XG5cbmxldCB2aWV3OiBWaWV3ID0gdW5kZWZpbmVkO1xuXG5leHBvcnQgZnVuY3Rpb24gb25OYXZpZ2F0aW5nVG8oYXJnczogTmF2aWdhdGVkRGF0YSkge1xuICAgIExvZy5wcmludChcIm5hdmlnYXRpbmcgdG86IHBhcnRpZXMtcGFnZVwiKTtcbiAgICB2aWV3ID0gPFZpZXc+YXJncy5vYmplY3Q7XG4gICAgdmlldy5iaW5kaW5nQ29udGV4dCA9IGZyb21PYmplY3Qoe1xuICAgICAgICBwYXJ0eTogdW5kZWZpbmVkLFxuICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICBxcmNvZGU6IHVuZGVmaW5lZFxuICAgIH0pO1xuICAgIHJldHVybiBsb2FkUGFydGllcygpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVWaWV3KHBhcnR5OiBCYWRnZS5CYWRnZSkge1xuICAgIGlmIChwYXJ0eSkge1xuICAgICAgICB2aWV3LmJpbmRpbmdDb250ZXh0LmNvbmZpZyA9IHBhcnR5LmNvbmZpZztcbiAgICAgICAgdmlldy5iaW5kaW5nQ29udGV4dC5xcmNvZGUgPSBwYXJ0eS5xcmNvZGVQdWJsaWMoKTtcbiAgICAgICAgdmlldy5iaW5kaW5nQ29udGV4dC5wYXJ0eSA9IHBhcnR5O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZXcuYmluZGluZ0NvbnRleHQucGFydHkgPSB1bmRlZmluZWQ7XG4gICAgICAgIHZpZXcuYmluZGluZ0NvbnRleHQuY29uZmlnID0ge307XG4gICAgfVxufVxuXG5mdW5jdGlvbiBsb2FkUGFydGllcygpIHtcbiAgICByZXR1cm4gQmFkZ2UuQmFkZ2UubG9hZEFsbCgpXG4gICAgLy8gLnRoZW4od2FsbGV0cyA9PiB7XG4gICAgLy8gICAgIHJldHVybiBCYWRnZS5mZXRjaFVwY29taW5nKHdhbGxldHMpXG4gICAgLy8gfSlcbiAgICAgICAgLnRoZW4odXBjb21pbmcgPT4ge1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh1cGNvbWluZykuZm9yRWFjaChwYXJ0eSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcnR5LnN0YXRlKCkgPT0gQmFkZ2UuU1RBVEVfUFVCTElTSCkge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVWaWV3KHBhcnR5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBMb2cuY2F0Y2goZXJyKTtcbiAgICAgICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRQYXJ0eSgpIHtcbiAgICByZXR1cm4gU2Nhbi5zY2FuKClcbiAgICAgICAgLnRoZW4oc3RyaW5nID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluZm9zID0gQ29udmVydC5qc29uVG9PYmplY3Qoc3RyaW5nKTtcbiAgICAgICAgICAgIHJldHVybiBCYWRnZS5NaWdyYXRlRnJvbS5jb25vZGVHZXRXYWxsZXQoaW5mb3MuYWRkcmVzcyxcbiAgICAgICAgICAgICAgICBpbmZvcy5vbW5pbGVkZ2VySWQsIGluZm9zLmlkKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgIHJldHVybiBEaWFsb2cucHJvbXB0KHtcbiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGZvciB0aGUgaU9TIHNpbXVsYXRvciB0aGF0IGRvZXNuJ3QgaGF2ZSBhXG4gICAgICAgICAgICAgICAgLy8gY2FtZXJhIC0gaW4gdGhlIHNpbXVsYXRvciBpdCdzIGVhc3kgdG8gY29weS9wYXN0ZSB0aGVcbiAgICAgICAgICAgICAgICAvLyBwYXJ0eS1pZCwgd2hlcmVhcyBvbiBhIHJlYWwgcGhvbmUgeW91IHdvdWxkbid0IHdhbnRcbiAgICAgICAgICAgICAgICAvLyB0byBkbyB0aGF0LlxuICAgICAgICAgICAgICAgIHRpdGxlOiBcIlBhcnR5LUlEXCIsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJDb3VsZG4ndCBzY2FuIHBhcnR5LWlkLiBQbGVhc2UgZW50ZXIgcGFydHktaWQgbWFudWFsbHkuXCIsXG4gICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIkpvaW4gUGFydHlcIixcbiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIlF1aXRcIixcbiAgICAgICAgICAgICAgICBkZWZhdWx0VGV4dDogXCJcIixcbiAgICAgICAgICAgICAgICBpbnB1dFR5cGU6IERpYWxvZy5pbnB1dFR5cGUudGV4dFxuICAgICAgICAgICAgfSkudGhlbihyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmFkZ2UuTWlncmF0ZUZyb20uY29ub2RlR2V0V2FsbGV0KFwidGxzOi8vZ2Fzc2VyLmJsdWU6NzAwMlwiLCBSZXF1ZXN0UGF0aC5PTU5JTEVER0VSX0lOU1RBTkNFX0lELCByLnRleHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFib3J0ZWQgcGFydHktaWRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuICAgICAgICAudGhlbihuZXdQYXJ0eSA9PiB7XG4gICAgICAgICAgICBuZXdQYXJ0eS5hdHRlbmRlZXNBZGQoW25ld1BhcnR5LmtleXBhaXIucHVibGljXSk7XG4gICAgICAgICAgICByZXR1cm4gbmV3UGFydHkuc2F2ZSgpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVWaWV3KG5ld1BhcnR5KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIERpYWxvZy5hbGVydCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJTYXZpbmcgZXJyb3JcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQ291bGRuJ3Qgc2F2ZSB0aGUgcGFydHk6IFwiICsgZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiT0tcIlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBMb2cuY2F0Y2goZXJyLCBcImVycm9yOlwiKTtcbiAgICAgICAgICAgIHJldHVybiBEaWFsb2cuYWxlcnQoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBcIlJlbW90ZSBwYXJ0aWVzIGVycm9yXCIsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyLFxuICAgICAgICAgICAgICAgIG9rQnV0dG9uVGV4dDogXCJDb250aW51ZVwiXG4gICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJ0eVRhcChhcmdzOiBFdmVudERhdGEpIHtcbiAgICBpZiAoIXZpZXcuYmluZGluZ0NvbnRleHQucGFydHkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGFjdGlvblNoYXJlID0gXCJTaGFyZSBwYXJ0eS1kZWZpbml0aW9uXCI7XG4gICAgY29uc3QgYWN0aW9uRGVsZXRlID0gXCJEZWxldGUgcGFydHlcIjtcblxuICAgIHJldHVybiBEaWFsb2cuYWN0aW9uKHtcbiAgICAgICAgbWVzc2FnZTogXCJXaGF0IGRvIHlvdSB3YW50IHRvIGRvP1wiLFxuICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIkNhbmNlbFwiLFxuICAgICAgICBhY3Rpb25zOiBbYWN0aW9uU2hhcmUsIGFjdGlvbkRlbGV0ZV1cbiAgICB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHN3aXRjaCAocmVzdWx0KSB7XG4gICAgICAgICAgICBjYXNlIGFjdGlvblNoYXJlOlxuICAgICAgICAgICAgICAgIHZpZXcuc2hvd01vZGFsKFwicGFnZXMvY29tbW9uL3FyLWNvZGUvcXItY29kZS1wYWdlXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgdGV4dFRvU2hvdzogQ29udmVydC5vYmplY3RUb0pzb24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHZpZXcuYmluZGluZ0NvbnRleHQucGFydHkuY29uZmlnLmhhc2hTdHIoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9tbmlsZWRnZXJJZDogUmVxdWVzdFBhdGguT01OSUxFREdFUl9JTlNUQU5DRV9JRCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHZpZXcuYmluZGluZ0NvbnRleHQucGFydHkubGlua2VkQ29ub2RlLnRjcEFkZHJcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIlBhcnR5IGluZm9ybWF0aW9uXCIsXG4gICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIH0sIHRydWUpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBhY3Rpb25EZWxldGU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIERpYWxvZy5jb25maXJtKFwiRG8geW91IHJlYWxseSB3YW50IHRvIGRlbGV0ZSB0aGF0IHBhcnR5P1wiKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihkZWwgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuYmluZGluZ0NvbnRleHQucGFydHkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVWaWV3KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgTG9nLnJjYXRjaChlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvblJlbG9hZCgpIHtcbn0iXX0=
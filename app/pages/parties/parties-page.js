"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Dialog = require("tns-core-modules/ui/dialogs");
const Badge = require("~/lib/pop/Badge");
const Log_1 = require("~/lib/Log");
const Scan = require("~/lib/Scan");
const Convert = require("~/lib/Convert");
const observable_1 = require("tns-core-modules/data/observable");
const app_1 = require("~/app");
const Defaults = require("~/lib/Defaults");
let view = undefined;
function onNavigatingTo(args) {
    view = args.object;
    view.bindingContext = observable_1.fromObject({
        party: undefined,
        config: {},
        qrcode: undefined
    });
    return loadParties();
}
exports.onNavigatingTo = onNavigatingTo;
function updateView(party) {
    if (party) {
        view.bindingContext.config = party.config;
        view.bindingContext.qrcode = party.qrcodePublic();
        view.bindingContext.party = party;
    }
    else {
        view.bindingContext.party = undefined;
        view.bindingContext.config = {};
    }
}
function loadParties() {
    app_1.gData.parties.forEach(party => {
        updateView(party);
    });
}
function addParty() {
    return Scan.scan()
        .then(string => {
        const infos = Convert.jsonToObject(string);
        return Badge.MigrateFrom.conodeGetWallet(infos.address, infos.omniledgerId, infos.id);
    })
        .catch(error => {
        return Dialog.prompt({
            // This is for the iOS simulator that doesn't have a
            // camera - in the simulator it's easy to copy/paste the
            // party-id, whereas on a real phone you wouldn't want
            // to do that.
            title: "Party-ID",
            message: "Couldn't scan party-id. Please enter party-id manually.",
            okButtonText: "Join Party",
            cancelButtonText: "Quit",
            defaultText: "",
            inputType: Dialog.inputType.text
        }).then(r => {
            if (r.result) {
                return Badge.MigrateFrom.conodeGetWallet("tls://gasser.blue:7002", Defaults.OMNILEDGER_INSTANCE_ID, r.text);
            }
            else {
                throw new Error("Aborted party-id");
            }
        });
    })
        .then(newParty => {
        newParty.attendeesAdd([newParty.keypair.public]);
        return newParty.save()
            .then(() => {
            app_1.gData.addParty(newParty);
            updateView(newParty);
        })
            .catch(error => {
            Dialog.alert({
                title: "Saving error",
                message: "Couldn't save the party: " + error,
                okButtonText: "OK"
            });
        });
    })
        .catch(err => {
        Log_1.default.catch(err, "error:");
        return Dialog.alert({
            title: "Remote parties error",
            message: err,
            okButtonText: "Continue"
        }).then(() => {
            throw new Error(err);
        });
    });
}
exports.addParty = addParty;
function partyTap(args) {
    if (!view.bindingContext.party) {
        return;
    }
    const actionShare = "Share party-definition";
    const actionDelete = "Delete party";
    return Dialog.action({
        message: "What do you want to do?",
        cancelButtonText: "Cancel",
        actions: [actionShare, actionDelete]
    }).then(result => {
        switch (result) {
            case actionShare:
                view.showModal("pages/common/qr-code/qr-code-page", {
                    textToShow: Convert.objectToJson({
                        id: view.bindingContext.party.config.hashStr(),
                        omniledgerId: Defaults.OMNILEDGER_INSTANCE_ID,
                        address: view.bindingContext.party.linkedConode.tcpAddr
                    }),
                    title: "Party information",
                }, () => {
                }, true);
                break;
            case actionDelete:
                return Dialog.confirm("Do you really want to delete that party?")
                    .then(del => {
                    if (del) {
                        view.bindingContext.party.remove();
                    }
                    updateView(undefined);
                })
                    .catch(err => {
                    Log_1.default.rcatch(err);
                });
        }
    });
}
exports.partyTap = partyTap;
function onReload() {
}
exports.onReload = onReload;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGllcy1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGFydGllcy1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esc0RBQXNEO0FBRXRELHlDQUF5QztBQUN6QyxtQ0FBNEI7QUFDNUIsbUNBQW1DO0FBQ25DLHlDQUF5QztBQUN6QyxpRUFBNEQ7QUFDNUQsK0JBQTRCO0FBQzVCLDJDQUEyQztBQUUzQyxJQUFJLElBQUksR0FBUyxTQUFTLENBQUM7QUFFM0Isd0JBQStCLElBQW1CO0lBQzlDLElBQUksR0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsdUJBQVUsQ0FBQztRQUM3QixLQUFLLEVBQUUsU0FBUztRQUNoQixNQUFNLEVBQUUsRUFBRTtRQUNWLE1BQU0sRUFBRSxTQUFTO0tBQ3BCLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUN6QixDQUFDO0FBUkQsd0NBUUM7QUFFRCxvQkFBb0IsS0FBa0I7SUFDbEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNSLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDMUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2xELElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN0QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFDdEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBQ3BDLENBQUM7QUFDTCxDQUFDO0FBRUQ7SUFDSSxXQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMxQixVQUFVLENBQUMs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QUFDO1FBQ2YsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQztBQXRDRCw0QkFzQ0M7QUFFRDtBQUNBLENBQUM7QUFERCw0QkFDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXZlbnREYXRhLCBOYXZpZ2F0ZWREYXRhLCBQYWdlLCBWaWV3fSBmcm9tIFwidWkvcGFnZVwiO1xuaW1wb3J0ICogYXMgRGlhbG9nIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL3VpL2RpYWxvZ3NcIjtcblxuaW1wb3J0ICogYXMgQmFkZ2UgZnJvbSBcIn4vbGliL3BvcC9CYWRnZVwiO1xuaW1wb3J0IExvZyBmcm9tIFwifi9saWIvTG9nXCI7XG5pbXBvcnQgKiBhcyBTY2FuIGZyb20gXCJ+L2xpYi9TY2FuXCI7XG5pbXBvcnQgKiBhcyBDb252ZXJ0IGZyb20gXCJ+L2xpYi9Db252ZXJ0XCI7XG5pbXBvcnQge2Zyb21PYmplY3R9IGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2RhdGEvb2JzZXJ2YWJsZVwiO1xuaW1wb3J0IHtnRGF0YX0gZnJvbSBcIn4vYXBwXCI7XG5pbXBvcnQgKiBhcyBEZWZhdWx0cyBmcm9tIFwifi9saWIvRGVmYXVsdHNcIjtcblxubGV0IHZpZXc6IFZpZXcgPSB1bmRlZmluZWQ7XG5cbmV4cG9ydCBmdW5jdGlvbiBvbk5hdmlnYXRpbmdUbyhhcmdzOiBOYXZpZ2F0ZWREYXRhKSB7XG4gICAgdmlldyA9IDxWaWV3PmFyZ3Mub2JqZWN0O1xuICAgIHZpZXcuYmluZGluZ0NvbnRleHQgPSBmcm9tT2JqZWN0KHtcbiAgICAgICAgcGFydHk6IHVuZGVmaW5lZCxcbiAgICAgICAgY29uZmlnOiB7fSxcbiAgICAgICAgcXJjb2RlOiB1bmRlZmluZWRcbiAgICB9KTtcbiAgICByZXR1cm4gbG9hZFBhcnRpZXMoKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlVmlldyhwYXJ0eTogQmFkZ2UuQmFkZ2UpIHtcbiAgICBpZiAocGFydHkpIHtcbiAgICAgICAgdmlldy5iaW5kaW5nQ29udGV4dC5jb25maWcgPSBwYXJ0eS5jb25maWc7XG4gICAgICAgIHZpZXcuYmluZGluZ0NvbnRleHQucXJjb2RlID0gcGFydHkucXJjb2RlUHVibGljKCk7XG4gICAgICAgIHZpZXcuYmluZGluZ0NvbnRleHQucGFydHkgPSBwYXJ0eTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2aWV3LmJpbmRpbmdDb250ZXh0LnBhcnR5ID0gdW5kZWZpbmVkO1xuICAgICAgICB2aWV3LmJpbmRpbmdDb250ZXh0LmNvbmZpZyA9IHt9O1xuICAgIH1cbn1cblxuZnVuY3Rpb24gbG9hZFBhcnRpZXMoKSB7XG4gICAgZ0RhdGEucGFydGllcy5mb3JFYWNoKHBhcnR5ID0+IHtcbiAgICAgICAgdXBkYXRlVmlldyhwYXJ0eSk7XG4gICAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZFBhcnR5KCkge1xuICAgIHJldHVybiBTY2FuLnNjYW4oKVxuICAgICAgICAudGhlbihzdHJpbmcgPT4ge1xuICAgICAgICAgICAgY29uc3QgaW5mb3MgPSBDb252ZXJ0Lmpzb25Ub09iamVjdChzdHJpbmcpO1xuICAgICAgICAgICAgcmV0dXJuIEJhZGdlLk1pZ3JhdGVGcm9tLmNvbm9kZUdldFdhbGxldChpbmZvcy5hZGRyZXNzLFxuICAgICAgICAgICAgICAgIGluZm9zLm9tbmlsZWRnZXJJZCwgaW5mb3MuaWQpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIERpYWxvZy5wcm9tcHQoe1xuICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgZm9yIHRoZSBpT1Mgc2ltdWxhdG9yIHRoYXQgZG9lc24ndCBoYXZlIGFcbiAgICAgICAgICAgICAgICAvLyBjYW1lcmEgLSBpbiB0aGUgc2ltdWxhdG9yIGl0J3MgZWFzeSB0byBjb3B5L3Bhc3RlIHRoZVxuICAgICAgICAgICAgICAgIC8vIHBhcnR5LWlkLCB3aGVyZWFzIG9uIGEgcmVhbCBwaG9uZSB5b3Ugd291bGRuJ3Qgd2FudFxuICAgICAgICAgICAgICAgIC8vIHRvIGRvIHRoYXQuXG4gICAgICAgICAgICAgICAgdGl0bGU6IFwiUGFydHktSURcIixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIkNvdWxkbid0IHNjYW4gcGFydHktaWQuIFBsZWFzZSBlbnRlciBwYXJ0eS1pZCBtYW51YWxseS5cIixcbiAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiSm9pbiBQYXJ0eVwiLFxuICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiUXVpdFwiLFxuICAgICAgICAgICAgICAgIGRlZmF1bHRUZXh0OiBcIlwiLFxuICAgICAgICAgICAgICAgIGlucHV0VHlwZTogRGlhbG9nLmlucHV0VHlwZS50ZXh0XG4gICAgICAgICAgICB9KS50aGVuKHIgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyLnJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmFkZ2UuTWlncmF0ZUZyb20uY29ub2RlR2V0V2FsbGV0KFwidGxzOi8vZ2Fzc2VyLmJsdWU6NzAwMlwiLCBEZWZhdWx0cy5PTU5JTEVER0VSX0lOU1RBTkNFX0lELCByLnRleHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFib3J0ZWQgcGFydHktaWRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuICAgICAgICAudGhlbihuZXdQYXJ0eSA9PiB7XG4gICAgICAgICAgICBuZXdQYXJ0eS5hdHRlbmRlZXNBZGQoW25ld1BhcnR5LmtleXBhaXIucHVibGljXSk7XG4gICAgICAgICAgICByZXR1cm4gbmV3UGFydHkuc2F2ZSgpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBnRGF0YS5hZGRQYXJ0eShuZXdQYXJ0eSk7XG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZVZpZXcobmV3UGFydHkpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgRGlhbG9nLmFsZXJ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIlNhdmluZyBlcnJvclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogXCJDb3VsZG4ndCBzYXZlIHRoZSBwYXJ0eTogXCIgKyBlcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uVGV4dDogXCJPS1wiXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIExvZy5jYXRjaChlcnIsIFwiZXJyb3I6XCIpO1xuICAgICAgICAgICAgcmV0dXJuIERpYWxvZy5hbGVydCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IFwiUmVtb3RlIHBhcnRpZXMgZXJyb3JcIixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIsXG4gICAgICAgICAgICAgICAgb2tCdXR0b25UZXh0OiBcIkNvbnRpbnVlXCJcbiAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnR5VGFwKGFyZ3M6IEV2ZW50RGF0YSkge1xuICAgIGlmICghdmlldy5iaW5kaW5nQ29udGV4dC5wYXJ0eSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYWN0aW9uU2hhcmUgPSBcIlNoYXJlIHBhcnR5LWRlZmluaXRpb25cIjtcbiAgICBjb25zdCBhY3Rpb25EZWxldGUgPSBcIkRlbGV0ZSBwYXJ0eVwiO1xuXG4gICAgcmV0dXJuIERpYWxvZy5hY3Rpb24oe1xuICAgICAgICBtZXNzYWdlOiBcIldoYXQgZG8geW91IHdhbnQgdG8gZG8/XCIsXG4gICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiQ2FuY2VsXCIsXG4gICAgICAgIGFjdGlvbnM6IFthY3Rpb25TaGFyZSwgYWN0aW9uRGVsZXRlXVxuICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgc3dpdGNoIChyZXN1bHQpIHtcbiAgICAgICAgICAgIGNhc2UgYWN0aW9uU2hhcmU6XG4gICAgICAgICAgICAgICAgdmlldy5zaG93TW9kYWwoXCJwYWdlcy9jb21tb24vcXItY29kZS9xci1jb2RlLXBhZ2VcIiwge1xuICAgICAgICAgICAgICAgICAgICB0ZXh0VG9TaG93OiBDb252ZXJ0Lm9iamVjdFRvSnNvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogdmlldy5iaW5kaW5nQ29udGV4dC5wYXJ0eS5jb25maWcuaGFzaFN0cigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgb21uaWxlZGdlcklkOiBEZWZhdWx0cy5PTU5JTEVER0VSX0lOU1RBTkNFX0lELFxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogdmlldy5iaW5kaW5nQ29udGV4dC5wYXJ0eS5saW5rZWRDb25vZGUudGNwQWRkclxuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiUGFydHkgaW5mb3JtYXRpb25cIixcbiAgICAgICAgICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgfSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGFjdGlvbkRlbGV0ZTpcbiAgICAgICAgICAgICAgICByZXR1cm4gRGlhbG9nLmNvbmZpcm0oXCJEbyB5b3UgcmVhbGx5IHdhbnQgdG8gZGVsZXRlIHRoYXQgcGFydHk/XCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGRlbCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5iaW5kaW5nQ29udGV4dC5wYXJ0eS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVZpZXcodW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBMb2cucmNhdGNoKGVycik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uUmVsb2FkKCkge1xufSJdfQ==
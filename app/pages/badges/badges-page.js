"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const badges_view_model_1 = require("./badges-view-model");
const Dialog = require("tns-core-modules/ui/dialogs");
const frame_1 = require("tns-core-modules/ui/frame");
let lib = require("../../lib");
let Badge = lib.pop.Badge;
let Log = lib.Log.default;
let Scan = lib.Scan;
let Convert = lib.Convert;
let RingSig = lib.crypto.RingSig;
let page = undefined;
let pageObject = undefined;
const USER_CANCELED = "Cancel";
function convertBinaryStringToUint8Array(bStr) {
    let len = bStr.length, u8_array = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        u8_array[i] = bStr.charCodeAt(i);
    }
    return u8_array;
}
function onNavigatingTo(args) {
    Log.print("getting to badges");
    page = args.object;
    page.bindingContext = new badges_view_model_1.BadgesViewModel();
    Log.print("isempty:", page.bindingContext.isEmpty);
    return loadParties();
}
exports.onNavigatingTo = onNavigatingTo;
function loadParties() {
    Log.lvl1("Loading parties");
    return Badge.Badge.loadAll()
        .then(badges => {
        return Badge.Badge.updateAll();
    })
        .then(badges => {
        page.bindingContext.isEmpty = true;
        Object.values(badges).forEach((badge, index) => {
            Log.print("Found badge with state:", badge.state());
            if (badge.state() == Badge.STATE_TOKEN) {
                page.bindingContext.items.push({
                    party: badge,
                    name: badge.config.name,
                    datetime: badge.config.datetime,
                    location: badge.config.location,
                    index: index + 1
                });
                page.bindingContext.isEmpty = false;
            }
        });
    })
        .catch(err => {
        Log.catch(err);
    });
}
function partyTapped(args) {
    const index = args.index;
    const party = page.bindingContext.items[index].party;
    const WALLET_DELETE = "Delete";
    const WALLET_SHOW = "Show";
    const WALLET_SIGN = "Sign service";
    let actions = [WALLET_SHOW, WALLET_DELETE];
    Log.print("State is:", party.state());
    if (party.state() == Badge.STATE_TOKEN) {
        actions.unshift(WALLET_SIGN);
        // actions.unshift(WALLET_TRANSFER, WALLET_SIGN)
    }
    // return topmost().getViewById("listView").refresh()
    return Dialog.action({
        message: "Choose an Action",
        cancelButtonText: "Cancel",
        actions: actions
    }).then(result => {
        switch (result) {
            case WALLET_DELETE:
                Dialog.confirm({
                    title: "Deleting party-token",
                    message: "You're about to delete the party-token - \n" +
                        "are you sure?",
                    okButtonText: "Yes, delete",
                    cancelButtonText: "No, keep"
                })
                    .then(del => {
                    if (del) {
                        return party.remove()
                            .then(() => {
                            page.bindingContext.items.splice(index, 1);
                            return pageObject.getViewById("listView").refresh();
                        });
                    }
                })
                    .catch(err => {
                    console.log("error while deleting:", err);
                });
            case WALLET_SHOW:
                return frame_1.topmost().navigate({
                    moduleName: "drawers/pop/org/config/config-page",
                    context: {
                        wallet: party,
                        readOnly: true
                    }
                });
            case WALLET_SIGN:
                return Scan.scan()
                    .then(signDataJson => {
                    const sigData = Convert.jsonToObject(signDataJson);
                    const sig = RingSig.signWithPopToken(party.getPopToken(), Convert.hexToByteArray(sigData.nonce), Convert.hexToByteArray(sigData.scope));
                    const fields = {
                        signature: Convert.byteArrayToHex(sig)
                    };
                    return pageObject.showModal("shared/pages/qr-code/qr-code-page", {
                        textToShow: Convert.objectToJson(fields),
                        title: "Signed informations"
                    });
                })
                    .catch(error => {
                    console.log("couldn't scan:", error);
                    if (error !== Scan.SCAN_ABORTED) {
                        return Dialog.alert({
                            title: "Error",
                            message: "An error occured, please retry. - " + error,
                            okButtonText: "Ok"
                        });
                    }
                });
        }
    });
}
exports.partyTapped = partyTapped;
function update() {
    pageObject.getViewById("listView").refresh();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFkZ2VzLXBhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJiYWRnZXMtcGFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLDJEQUFvRDtBQUNwRCxzREFBc0Q7QUFDdEQscURBQWtEO0FBRWxELElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMvQixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQztBQUMxQixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztBQUMxQixJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO0FBQ3BCLElBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUM7QUFDMUIsSUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7QUFFakMsSUFBSSxJQUFJLEdBQVMsU0FBUyxDQUFDO0FBQzNCLElBQUksVUFBVSxHQUFHLFNBQVMsQ0FBQztBQUUzQixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUM7QUFFL0IseUNBQXlDLElBQUk7SUFDekMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdEQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMzQixRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBQ0QsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUNwQixDQUFDO0FBRUQsd0JBQStCLElBQW1CO0lBQzlDLEdBQUcsQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUMvQixJQUFJLEdBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN6QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksbUNBQWUsRUFBRSxDQUFDO0lBQzVDLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkQsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ3pCLENBQUM7QUFORCx3Q0FNQztBQUVEO0lBQ0ksR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzVCLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRTtTQUN2QixJQUFJLENBQUMsTUFBTSxDQUFBLEVBQUU7UUFDVixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNuQyxDQUFDLENBQUM7U0FDRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDWCxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFTLEVBQUUsS0FBWSxFQUFFLEVBQUU7WUFDdEQsR0FBRyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNwRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztvQkFDM0IsS0FBSyxFQUFFLEtBQUs7b0JBQ1osSUFBSSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSTtvQkFDdkIsUUFBUSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUTtvQkFDL0IsUUFBUSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUTtvQkFDL0IsS0FBSyxFQUFFLEtBQUssR0FBRyxDQUFDO2lCQUNuQixDQUFDLENBQUE7Z0JBQ0YsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1lBQ3hDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztTQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNULEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBRUQscUJBQTRCLElBQUk7SUFDNUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN6QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFFckQsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDO0lBQy9CLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQztJQUMzQixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUM7SUFFbkMsSUFBSSxPQUFPLEdBQUcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDM0MsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDdEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDN0IsZ0RBQWdEO0lBQ3BELENBQUM7SUFDRCxxREFBcUQ7SUFDckQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDakIsT0FBTyxFQUFFLGtCQUFrQjtRQUMzQixnQkFBZ0IsRUFBRSxRQUFRO1FBQzFCLE9BQU8sRUFBRSxPQUFPO0tBQ25CLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDYixNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2IsS0FBSyxhQUFhO2dCQUNkLE1BQU0sQ0FBQyxPQUFPLENBQUM7b0JBQ1gsS0FBSyxFQUFFLHNCQUFzQjtvQkFDN0IsT0FBTyxFQUFFLDZDQUE2Qzt3QkFDbEQsZUFBZTtvQkFDbkIsWUFBWSxFQUFFLGFBQWE7b0JBQzNCLGdCQUFnQixFQUFFLFVBQVU7aUJBQy9CLENBQUM7cUJBQ0csSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUNSLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBQ04sTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7NkJBQ2hCLElBQUksQ0FBQyxHQUFHLEVBQUU7NEJBQ1AsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQzs0QkFDM0MsTUFBTSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7d0JBQ3hELENBQUMsQ0FBQyxDQUFBO29CQUNWLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDO3FCQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsQ0FBQTtZQUNWLEtBQUssV0FBVztnQkFDWixNQUFNLENBQUMsZUFBTyxFQUFFLENBQUMsUUFBUSxDQUFDO29CQUN0QixVQUFVLEVBQUUsb0NBQW9DO29CQUNoRCxPQUFPLEVBQUU7d0JBQ0wsTUFBTSxFQUFFLEtBQUs7d0JBQ2IsUUFBUSxFQUFFLElBQUk7cUJBQ2pCO2lCQUNKLENBQUMsQ0FBQztZQUNQLEtBQUssV0FBVztnQkFDWixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtxQkFDYixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQ2pCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQ25ELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQ3BELE9BQU8sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBRWxGLE1BQU0sTUFBTSxHQUFHO3dCQUNYLFNBQVMsRUFBRSxPQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQztxQkFDekMsQ0FBQztvQkFFRixNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxtQ0FBbUMsRUFBRTt3QkFDN0QsVUFBVSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO3dCQUN4QyxLQUFLLEVBQUUscUJBQXFCO3FCQUMvQixDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxDQUFDO3FCQUNELEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtvQkFDWCxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUVyQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7d0JBQzlCLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDOzRCQUNoQixLQUFLLEVBQUUsT0FBTzs0QkFDZCxPQUFPLEVBQUUsb0NBQW9DLEdBQUcsS0FBSzs0QkFDckQsWUFBWSxFQUFFLElBQUk7eUJBQ3JCLENBQUMsQ0FBQztvQkFDUCxDQUFDO2dCQUVMLENBQUMsQ0FBQyxDQUFDO1FBQ2YsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQS9FRCxrQ0ErRUM7QUFFRDtJQUNJLFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDakQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Vmlld30gZnJvbSBcInVpL2NvcmUvdmlld1wiO1xuaW1wb3J0IHtJdGVtRXZlbnREYXRhfSBmcm9tIFwidWkvbGlzdC12aWV3XCI7XG5pbXBvcnQge0l0ZW19IGZyb20gXCIuL3NoYXJlZC9pdGVtXCI7XG5pbXBvcnQge05hdmlnYXRlZERhdGEsIFBhZ2V9IGZyb20gXCJ1aS9wYWdlXCI7XG5pbXBvcnQge0JhZGdlc1ZpZXdNb2RlbH0gZnJvbSBcIi4vYmFkZ2VzLXZpZXctbW9kZWxcIjtcbmltcG9ydCAqIGFzIERpYWxvZyBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9kaWFsb2dzXCI7XG5pbXBvcnQge3RvcG1vc3R9IGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL3VpL2ZyYW1lXCI7XG5cbmxldCBsaWIgPSByZXF1aXJlKFwiLi4vLi4vbGliXCIpO1xubGV0IEJhZGdlID0gbGliLnBvcC5CYWRnZTtcbmxldCBMb2cgPSBsaWIuTG9nLmRlZmF1bHQ7XG5sZXQgU2NhbiA9IGxpYi5TY2FuO1xubGV0IENvbnZlcnQgPSBsaWIuQ29udmVydDtcbmxldCBSaW5nU2lnID0gbGliLmNyeXB0by5SaW5nU2lnO1xuXG5sZXQgcGFnZTogUGFnZSA9IHVuZGVmaW5lZDtcbmxldCBwYWdlT2JqZWN0ID0gdW5kZWZpbmVkO1xuXG5jb25zdCBVU0VSX0NBTkNFTEVEID0gXCJDYW5jZWxcIjtcblxuZnVuY3Rpb24gY29udmVydEJpbmFyeVN0cmluZ1RvVWludDhBcnJheShiU3RyKSB7XG4gICAgbGV0IGxlbiA9IGJTdHIubGVuZ3RoLCB1OF9hcnJheSA9IG5ldyBVaW50OEFycmF5KGxlbik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgICB1OF9hcnJheVtpXSA9IGJTdHIuY2hhckNvZGVBdChpKTtcbiAgICB9XG4gICAgcmV0dXJuIHU4X2FycmF5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb25OYXZpZ2F0aW5nVG8oYXJnczogTmF2aWdhdGVkRGF0YSkge1xuICAgIExvZy5wcmludChcImdldHRpbmcgdG8gYmFkZ2VzXCIpO1xuICAgIHBhZ2UgPSA8UGFnZT5hcmdzLm9iamVjdDtcbiAgICBwYWdlLmJpbmRpbmdDb250ZXh0ID0gbmV3IEJhZGdlc1ZpZXdNb2RlbCgpO1xuICAgIExvZy5wcmludChcImlzZW1wdHk6XCIsIHBhZ2UuYmluZGluZ0NvbnRleHQuaXNFbXB0eSk7XG4gICAgcmV0dXJuIGxvYWRQYXJ0aWVzKCk7XG59XG5cbmZ1bmN0aW9uIGxvYWRQYXJ0aWVzKCkge1xuICAgIExvZy5sdmwxKFwiTG9hZGluZyBwYXJ0aWVzXCIpO1xuICAgIHJldHVybiBCYWRnZS5CYWRnZS5sb2FkQWxsKClcbiAgICAgICAgLnRoZW4oYmFkZ2VzPT57XG4gICAgICAgICAgICByZXR1cm4gQmFkZ2UuQmFkZ2UudXBkYXRlQWxsKCk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKGJhZGdlcyA9PiB7XG4gICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0LmlzRW1wdHkgPSB0cnVlO1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhiYWRnZXMpLmZvckVhY2goKGJhZGdlOmFueSwgaW5kZXg6bnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgTG9nLnByaW50KFwiRm91bmQgYmFkZ2Ugd2l0aCBzdGF0ZTpcIiwgYmFkZ2Uuc3RhdGUoKSk7XG4gICAgICAgICAgICAgICAgaWYgKGJhZGdlLnN0YXRlKCkgPT0gQmFkZ2UuU1RBVEVfVE9LRU4pIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZS5iaW5kaW5nQ29udGV4dC5pdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnR5OiBiYWRnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGJhZGdlLmNvbmZpZy5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZXRpbWU6IGJhZGdlLmNvbmZpZy5kYXRldGltZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiBiYWRnZS5jb25maWcubG9jYXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogaW5kZXggKyAxXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIHBhZ2UuYmluZGluZ0NvbnRleHQuaXNFbXB0eSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIExvZy5jYXRjaChlcnIpO1xuICAgICAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnR5VGFwcGVkKGFyZ3MpIHtcbiAgICBjb25zdCBpbmRleCA9IGFyZ3MuaW5kZXg7XG4gICAgY29uc3QgcGFydHkgPSBwYWdlLmJpbmRpbmdDb250ZXh0Lml0ZW1zW2luZGV4XS5wYXJ0eTtcblxuICAgIGNvbnN0IFdBTExFVF9ERUxFVEUgPSBcIkRlbGV0ZVwiO1xuICAgIGNvbnN0IFdBTExFVF9TSE9XID0gXCJTaG93XCI7XG4gICAgY29uc3QgV0FMTEVUX1NJR04gPSBcIlNpZ24gc2VydmljZVwiO1xuXG4gICAgbGV0IGFjdGlvbnMgPSBbV0FMTEVUX1NIT1csIFdBTExFVF9ERUxFVEVdO1xuICAgIExvZy5wcmludChcIlN0YXRlIGlzOlwiLCBwYXJ0eS5zdGF0ZSgpKTtcbiAgICBpZiAocGFydHkuc3RhdGUoKSA9PSBCYWRnZS5TVEFURV9UT0tFTikge1xuICAgICAgICBhY3Rpb25zLnVuc2hpZnQoV0FMTEVUX1NJR04pO1xuICAgICAgICAvLyBhY3Rpb25zLnVuc2hpZnQoV0FMTEVUX1RSQU5TRkVSLCBXQUxMRVRfU0lHTilcbiAgICB9XG4gICAgLy8gcmV0dXJuIHRvcG1vc3QoKS5nZXRWaWV3QnlJZChcImxpc3RWaWV3XCIpLnJlZnJlc2goKVxuICAgIHJldHVybiBEaWFsb2cuYWN0aW9uKHtcbiAgICAgICAgbWVzc2FnZTogXCJDaG9vc2UgYW4gQWN0aW9uXCIsXG4gICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiQ2FuY2VsXCIsXG4gICAgICAgIGFjdGlvbnM6IGFjdGlvbnNcbiAgICB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHN3aXRjaCAocmVzdWx0KSB7XG4gICAgICAgICAgICBjYXNlIFdBTExFVF9ERUxFVEU6XG4gICAgICAgICAgICAgICAgRGlhbG9nLmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJEZWxldGluZyBwYXJ0eS10b2tlblwiLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIllvdSdyZSBhYm91dCB0byBkZWxldGUgdGhlIHBhcnR5LXRva2VuIC0gXFxuXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhcmUgeW91IHN1cmU/XCIsXG4gICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uVGV4dDogXCJZZXMsIGRlbGV0ZVwiLFxuICAgICAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25UZXh0OiBcIk5vLCBrZWVwXCJcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihkZWwgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0eS5yZW1vdmUoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlLmJpbmRpbmdDb250ZXh0Lml0ZW1zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFnZU9iamVjdC5nZXRWaWV3QnlJZChcImxpc3RWaWV3XCIpLnJlZnJlc2goKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yIHdoaWxlIGRlbGV0aW5nOlwiLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgY2FzZSBXQUxMRVRfU0hPVzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdG9wbW9zdCgpLm5hdmlnYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlTmFtZTogXCJkcmF3ZXJzL3BvcC9vcmcvY29uZmlnL2NvbmZpZy1wYWdlXCIsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhbGxldDogcGFydHksXG4gICAgICAgICAgICAgICAgICAgICAgICByZWFkT25seTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjYXNlIFdBTExFVF9TSUdOOlxuICAgICAgICAgICAgICAgIHJldHVybiBTY2FuLnNjYW4oKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihzaWduRGF0YUpzb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2lnRGF0YSA9IENvbnZlcnQuanNvblRvT2JqZWN0KHNpZ25EYXRhSnNvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWcgPSBSaW5nU2lnLnNpZ25XaXRoUG9wVG9rZW4ocGFydHkuZ2V0UG9wVG9rZW4oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb252ZXJ0LmhleFRvQnl0ZUFycmF5KHNpZ0RhdGEubm9uY2UpLCBDb252ZXJ0LmhleFRvQnl0ZUFycmF5KHNpZ0RhdGEuc2NvcGUpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmllbGRzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZ25hdHVyZTogQ29udmVydC5ieXRlQXJyYXlUb0hleChzaWcpXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFnZU9iamVjdC5zaG93TW9kYWwoXCJzaGFyZWQvcGFnZXMvcXItY29kZS9xci1jb2RlLXBhZ2VcIiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRUb1Nob3c6IENvbnZlcnQub2JqZWN0VG9Kc29uKGZpZWxkcyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiU2lnbmVkIGluZm9ybWF0aW9uc1wiXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiY291bGRuJ3Qgc2NhbjpcIiwgZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IgIT09IFNjYW4uU0NBTl9BQk9SVEVEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIERpYWxvZy5hbGVydCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIkVycm9yXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQW4gZXJyb3Igb2NjdXJlZCwgcGxlYXNlIHJldHJ5LiAtIFwiICsgZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9rQnV0dG9uVGV4dDogXCJPa1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgIHBhZ2VPYmplY3QuZ2V0Vmlld0J5SWQoXCJsaXN0Vmlld1wiKS5yZWZyZXNoKCk7XG59XG4iXX0=